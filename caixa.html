<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Caixa - Timonha da Sorte</title>
  <style>
    * { box-sizing: border-box; font-family: Arial, sans-serif; }
    body { padding: 20px; background: #f5f5f5; }
    h1, h2 { color: #4CAF50; }
    input, button, select { padding: 8px; margin: 5px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #3CAF40; }
    .total-box { margin: 20px 0; padding: 15px; background: #2CAF10; border: 1px solid #3CAF20; }
    .totais span { display: inline-block; min-width: 150px; margin-right: 20px; font-weight: bold; }
    hr { margin: 30px 0; border: 1px solid #b30000; }
  </style>
</head>
<body>
  <h1>Movimento do Caixa</h1>
  <div class="total-box totais">
    <span>SALDO ANTERIOR: R$ <span id="saldoAnterior">0.00</span></span>
    <span>APURADO: R$ <span id="apuradoTotal">0.00</span></span>
    <span>DESPESAS: R$ <span id="despesasTotal">0.00</span></span>
    <span>SALDO FINAL: R$ <span id="saldoFinal">0.00</span></span>
  </div>

  <hr>

  <label>De: <input type="date" id="dataInicio"></label>
  <label>Até: <input type="date" id="dataFim"></label>
  <button onclick="filtrarVendas()">Filtrar</button>

  <h2>Resumo de Vendas</h2>
  <table id="tabelaResumo">
    <thead>
      <tr>
        <th>Data</th>
        <th>Vendedor</th>
        <th>Vendeu</th>
        <th>Apurou</th>
        <th>Pagou</th>
        <th>Deve</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Despesas</h2>
  <table id="tabelaDespesas">
    <thead>
      <tr>
        <th>Data</th>
        <th>Descrição</th>
        <th>Valor</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Partilha de Recursos</h2>
  <div class="total-box">
    <p>BENEDITO JUNIOR (25%): R$ <span id="benedito">0.00</span></p>
       <p>PEDRO CARVALHO (50%): R$ <span id="pedro">0.00</span></p>
  </div>

  <button onclick="gerarPDF()">Exportar em PDF</button>

  <script>
    function formatar(valor) {
      return parseFloat(valor).toFixed(2);
    }

    function carregarCaixa() {
      const vendas = JSON.parse(localStorage.getItem('vendas') || '{}');
      const despesas = JSON.parse(localStorage.getItem('despesas') || '[]');
      const receitas = JSON.parse(localStorage.getItem('receitas') || '[]');
      const vendedores = JSON.parse(localStorage.getItem('vendedores') || '[]');

      const saldoAnterior = receitas.reduce((acc, rec) => acc + parseFloat(rec.valor || 0), 0);
      let apurado = 0;
      const tbody = document.querySelector("#tabelaResumo tbody");
      tbody.innerHTML = "";

      for (const vendedor in vendas) {
        const vendedorObj = vendedores.find(v => v.nome === vendedor);
        const cotacaoVendedor = vendedorObj ? parseFloat(vendedorObj.cotacao) : 1;

        vendas[vendedor].forEach(v => {
          const vendeu = (v.recebeu || 0) - (v.devolveu || 0);
          const cotacao = v.cotacao !== undefined ? parseFloat(v.cotacao) : cotacaoVendedor || 1;
          const apurou = vendeu * cotacao;
          const deve = apurou - parseFloat(v.pagou || 0);

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${v.data || ''}</td>
            <td>${vendedor}</td>
            <td>${formatar(vendeu)}</td>
            <td>${formatar(apurou)}</td>
            <td>${formatar(v.pagou || 0)}</td>
            <td>${formatar(deve)}</td>`;
          tbody.appendChild(tr);
          apurado += apurou;
        });
      }

      document.getElementById('apuradoTotal').textContent = formatar(apurado);
      document.getElementById('saldoAnterior').textContent = formatar(saldoAnterior);

      const despesasTotais = despesas.reduce((acc, d) => acc + parseFloat(d.valor || 0), 0);
      document.getElementById('despesasTotal').textContent = formatar(despesasTotais);

      const saldoFinal = saldoAnterior + apurado - despesasTotais;
      document.getElementById('saldoFinal').textContent = formatar(saldoFinal);

      document.getElementById('benedito').textContent = formatar(saldoFinal * 0.10);
      document.getElementById('pedro').textContent = formatar(saldoFinal * 0.90);

      const tbodyDespesas = document.querySelector("#tabelaDespesas tbody");
      tbodyDespesas.innerHTML = "";
      despesas.forEach(d => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${d.data || ''}</td>
          <td>${d.descricao || ''}</td>
          <td>${formatar(d.valor)}</td>`;
        tbodyDespesas.appendChild(tr);
      });
    }

    function filtrarVendas() {
      const inicio = document.getElementById("dataInicio").value;
      const fim = document.getElementById("dataFim").value;
      if (!inicio || !fim) return carregarCaixa();

      const vendas = JSON.parse(localStorage.getItem('vendas') || '{}');
      const vendedores = JSON.parse(localStorage.getItem('vendedores') || '[]');
      const tbody = document.querySelector("#tabelaResumo tbody");
      tbody.innerHTML = "";
      let apurado = 0;

      for (const vendedor in vendas) {
        const vendedorObj = vendedores.find(v => v.nome === vendedor);
        const cotacaoVendedor = vendedorObj ? parseFloat(vendedorObj.cotacao) : 1;

        vendas[vendedor].forEach(v => {
          if (v.data >= inicio && v.data <= fim) {
            const vendeu = (v.recebeu || 0) - (v.devolveu || 0);
            const cotacao = v.cotacao !== undefined ? parseFloat(v.cotacao) : cotacaoVendedor || 1;
            const apurou = vendeu * cotacao;
            const deve = apurou - parseFloat(v.pagou || 0);

            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${v.data}</td>
              <td>${vendedor}</td>
              <td>${formatar(vendeu)}</td>
              <td>${formatar(apurou)}</td>
              <td>${formatar(v.pagou || 0)}</td>
              <td>${formatar(deve)}</td>`;
            tbody.appendChild(tr);
            apurado += apurou;
          }
        });
      }

      document.getElementById("apuradoTotal").textContent = formatar(apurado);
    }

    function gerarPDF() {
      window.print();
    }

    window.onload = carregarCaixa;
  </script>
</body>
</html>
